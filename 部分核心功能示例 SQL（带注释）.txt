-- 查询某读者当前借阅的书籍
SELECT 
    b.title, 
    br.borrow_date, 
    br.due_date,
    DATEDIFF(br.due_date, CURDATE()) AS days_remaining
FROM borrow_records br
JOIN books b ON br.book_id = b.book_id
WHERE br.reader_id = 1 
  AND br.status = '借出';

-- 查询某书的预约队列（按预约时间排序）
SELECT 
    r.name, 
    r.phone, 
    rs.reserve_date
FROM reservations rs
JOIN readers r ON rs.reader_id = r.reader_id
WHERE rs.book_id = 5 
  AND rs.status = '待取书'
ORDER BY rs.reserve_date ASC;

-- 计算某读者总罚款（未支付）
SELECT 
    SUM(amount) AS total_unpaid_fines
FROM fines
WHERE reader_id = 3 AND paid = FALSE;

-- 更新图书可借副本数（借出时）
UPDATE books 
SET available_copies = available_copies - 1
WHERE book_id = 10 AND available_copies > 0;

-- 归还图书时更新状态和可借副本数
UPDATE borrow_records 
SET status = '已还', return_date = CURDATE()
WHERE borrow_id = 100;

UPDATE books 
SET available_copies = available_copies + 1
WHERE book_id = (SELECT book_id FROM borrow_records WHERE borrow_id = 100);